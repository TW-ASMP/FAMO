# SPARQL 1.2.2

PREFIX famo: <http://ontology.eil.utoronto.ca/FAMO/famo/>
PREFIX famo_app: <http://ontology.eil.utoronto.ca/FAMO/famo_hub_application/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

#case 2a: object is not famo:nothing
INSERT {
GRAPH <http://www.torontowater.org/asmp/dh/operational/> {
#pattern for new data added via capital changes
?new_property_id a ?property_type.
?new_property_id famo:hasObject ?new_object;
		famo:hasSubject ?subject.
?new_object a ?new_object_type;
	famo:inProjectScope ?proj.
#other properties of the new object, if applicable
?new_object ?p ?val.
#plus any other metadata (source project, author, etc)
?proj famo:hasOutcomeProperty ?new_property_id.
#ordering relation with old (reconciliation) property
?old_property_id famo:hasNextManifestation ?new_property_id.
	}
}
WHERE {
#new properties to insert from staging graph
VALUES ?g1 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g1 {
?new_property_id famo:hasObject ?new_object.
OPTIONAL {?new_object a ?new_object_type}
#other properties of the new object, if applicable
OPTIONAL {?new_object ?p ?val}}

VALUES ?g2 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g2 {
		?new_property_id famo:hasSubject ?subject.}
		
VALUES ?g3 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g3{
		?new_property_id a ?property_type.}
		
VALUES ?g4 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g4 {
#need to match the subclass of property manifestation, not just any class that the property is a type of
?property_type rdfs:subClassOf famo:PropertyManifestation.
}

VALUES ?g4 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g4 {
#where the property is an outcome of the project
?proj famo:hasOutcomeProperty ?new_property_id.
	}
	
#where there exists some original (old) property in the staging graph (via reconciliation data)
VALUES ?g5 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g5 {
?old_property_id famo:hasObject ?old_object.
FILTER(?old_object!=?new_object)}

VALUES ?g6 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g6 {
		?old_property_id famo:hasSubject ?subject.}
		
VALUES ?g6 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g6 {
		?old_property_id a ?property_type.}

VALUES ?g7 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g7 {
?property_type rdfs:subClassOf famo:PropertyManifestation.}

VALUES ?g8 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g8 {
#where the property was an outcome of a reconciliation activity: finds or leadsToInformation
{ ?proj famo:finds ?old_property_id.}
UNION
{ ?proj famo:leadsToInformation ?old_property_id.}
	}
};

#case 2b - object is famo:nothing
INSERT {
GRAPH <http://www.torontowater.org/asmp/dh/operational/> {
#pattern for new data added via capital changes
?new_property_id a ?property_type.
?new_property_id famo:hasSubject ?subject.

#plus any other metadata (source project, author, etc)
?proj famo:hasOutcomeProperty ?new_property_id.
#ordering relation with old (reconciliation) property
?old_property_id famo:hasNextManifestation ?new_property_id.
	}
}
WHERE {
#new properties to insert from staging graph
VALUES ?g1 {<http://www.torontowater.org/asmp/dh/capital_nothing_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g1 {
?new_property_id famo:hasObject famo:nothing.}

VALUES ?g2 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g2 {
		?new_property_id famo:hasSubject ?subject.}
		
VALUES ?g3 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g3 {		
		?new_property_id a ?property_type.}

VALUES ?g4 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g4 {			
#need to match the subclass of property manifestation, not just any class that the property is a type of
?property_type rdfs:subClassOf famo:PropertyManifestation.}

VALUES ?g5 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g5 {	
#where the property is an outcome of the project
?proj famo:hasOutcomeProperty ?new_property_id.
	}
	
#where there exists some original (old) property in the staging graph (via reconciliation data)
VALUES ?g6 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g6 {
?old_property_id famo:hasObject ?old_object.
FILTER(?old_object!=famo:nothing)}

VALUES ?g7 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g7 {
		?old_property_id famo:hasSubject ?subject.}
		
VALUES ?g8 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g8 {
		?old_property_id a ?property_type.}

VALUES ?g9 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g9 {
?property_type rdfs:subClassOf famo:PropertyManifestation.}

VALUES ?g10 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g10 {
#where the property was an outcome of a reconciliation activity: finds or leadsToInformation
{ ?proj famo:finds ?old_property_id.}
UNION
{ ?proj famo:leadsToInformation ?old_property_id.}
}
};

#case 3a: object is not famo:nothing
INSERT {
GRAPH <http://www.torontowater.org/asmp/dh/operational/> {
#pattern for new data added via capital changes
?new_property_id a ?property_type.
?new_property_id famo:hasObject ?new_object;
		famo:hasSubject ?subject.
?new_object a ?new_object_type.
#other properties of the new object, if applicable
?new_object ?p ?val.
#plus any other metadata (source project, author, etc)
?proj famo:hasOutcomeProperty ?new_property_id.
?subject famo:inProjectScope ?proj.
?new_object famo:inProjectScope ?proj.
	}
}
WHERE {
#new properties to insert from staging graph
VALUES ?g1 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g1 {
?new_property_id famo:hasObject ?new_object.
OPTIONAL {?new_object a ?new_object_type} 
#other properties of the new object, if applicable
OPTIONAL {?new_object ?p ?val}}

VALUES ?g2 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g2 {
		?new_property_id famo:hasSubject ?subject.}

VALUES ?g3 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g3 {		
		?new_property_id a ?property_type.}

VALUES ?g4 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g4 {		
#need to match the subclass of property manifestation, not just any class that the property is a type of
?property_type rdfs:subClassOf famo:PropertyManifestation.}

VALUES ?g5 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g5 {		
#metadata defined in the staging graph
?proj famo:hasOutcomeProperty ?new_property_id.}

#requires a merge of the graphs
VALUES ?g6 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g6 {
#where the *current* value in the operational graph is not the same as (or does not exist) the capital change value
?property_type rdfs:subClassOf famo:PropertyManifestation.
FILTER NOT EXISTS {
?current_property_id famo:hasObject ?new_object;
		famo:hasSubject ?subject;
		a ?property_type;
		a famo:CurrentPropertyManifestation.
}

#and there does not exist some property in the operational graph (asserted via reconciliation data)
FILTER NOT EXISTS {
?old_property_id famo:hasObject ?old_object;
		famo:hasSubject ?subject;
		a ?property_type.
#where the property was an outcome of a reconciliation activity: finds or leadsToInformation
{
{ ?proj famo:finds ?old_property_id.}
UNION
{ ?proj famo:leadsToInformation ?old_property_id.}
}
	}
}
;

#case 3b: object is famo:nothing
INSERT {
GRAPH <http://www.torontowater.org/asmp/dh/operational/> {
#pattern for new data added via capital changes
?new_property_id a ?property_type.
?new_property_id famo:hasSubject ?subject.
#plus any other metadata (source project, author, etc)
?proj famo:hasOutcomeProperty ?new_property_id.
?subject famo:inProjectScope ?proj.
	}
}
WHERE {
#new properties to insert from staging graph
VALUES ?g1 {<http://www.torontowater.org/asmp/dh/capital_staging/>}
GRAPH ?g1 {
?new_property_id famo:hasObject famo:nothing.
}

VALUES ?g2 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/capital_nothing_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g2 {
		?new_property_id famo:hasSubject ?subject.}

VALUES ?g3 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/capital_nothing_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g3 {		
		?new_property_id a ?property_type.}
		
#need to match the subclass of property manifestation, not just any class that the property is a type of
VALUES ?g4 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/capital_nothing_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g4 {		
?property_type rdfs:subClassOf famo:PropertyManifestation.}

VALUES ?g5 {<http://www.torontowater.org/asmp/dh/capital_staging/> <http://www.torontowater.org/asmp/dh/capital_nothing_staging/> <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g5 {		
#metadata defined in the staging graph
?proj famo:finds ?new_property_id.
	}

#requires a merge of the graphs
VALUES ?g6 {<http://www.torontowater.org/asmp/dh/operational/> <http://www.torontowater.org/asmp/dh/operational_nothing/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g6 {
#where the current value in the operational graph is not the same as the capital change value
?property_type rdfs:subClassOf famo:PropertyManifestation.
FILTER NOT EXISTS {
?current_property_id famo:hasObject famo:nothing;
		famo:hasSubject ?subject;
		a ?property_type;
		a famo:CurrentPropertyManifestation.
}

#and where does not exist some original (old) property in the operational graph (via reconciliation data)
FILTER NOT EXISTS {
?old_property_id famo:hasObject ?old_object;
		famo:hasSubject ?subject;
		a ?property_type.
#where the property was an outcome of a reconciliation activity: finds or leadsToInformation
{
{ ?proj famo:finds ?old_property_id.}
UNION
{ ?proj famo:leadsToInformation ?old_property_id.}
}
	}
	
}
};

#case 4 - in progress
INSERT {
GRAPH <http://www.torontowater.org/asmp/dh/operational/> {
?subject famo:inProjectScope ?proj.
?new_object famo:inProjectScope ?proj.
	}
}
WHERE {
#new properties from staging graph
VALUES ?g1 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/capital_nothing_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g1 {
?new_property_id famo:hasObject ?new_object.
OPTIONAL {?new_object a ?new_object_type}}

VALUES ?g2 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/capital_nothing_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g2 {
		?new_property_id famo:hasSubject ?subject.}
		
VALUES ?g3 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/capital_nothing_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g3 {
		?new_property_id a ?property_type.}
		
VALUES ?g4 {<http://www.torontowater.org/asmp/dh/capital_staging/>  <http://www.torontowater.org/asmp/dh/capital_nothing_staging/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g4 {		
#need to match the subclass of property manifestation, not just any class that the property is a type of
?property_type rdfs:subClassOf famo:PropertyManifestation.}

#where there exists some current property in the staging graph that matches the new property
VALUES ?g5 {<http://www.torontowater.org/asmp/dh/operational/>  <http://www.torontowater.org/asmp/dh/operational_nothing/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g5 {
?old_property_id famo:hasObject ?new_object.}

VALUES ?g6 {<http://www.torontowater.org/asmp/dh/operational/>  <http://www.torontowater.org/asmp/dh/operational_nothing/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g6 {
		?old_property_id famo:hasSubject ?subject.
		#and there is no reconciliation data for the property
		#need a merge of the graphs to evaluate this
		FILTER NOT EXISTS{
		?old_property_id famo:hasObject ?old_object;
				famo:hasSubject ?subject;
				a ?property_type.
		#where the property was an outcome of a reconciliation activity: finds or leadsToInformation
		{
		{ ?proj famo:finds ?old_property_id.}
		UNION
		{ ?proj famo:leadsToInformation ?old_property_id.}
		}
			}
		}
		}
		
VALUES ?g7 {<http://www.torontowater.org/asmp/dh/operational/>  <http://www.torontowater.org/asmp/dh/operational_nothing/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g7 {
		?old_property_id a ?property_type.}
		
VALUES ?g9 {<http://www.torontowater.org/asmp/dh/operational/>  <http://www.torontowater.org/asmp/dh/operational_nothing/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g9 {
  ?old_property_id a famo:CurrentPropertyManifestation.}

VALUES ?g8 {<http://www.torontowater.org/asmp/dh/operational/>  <http://www.torontowater.org/asmp/dh/operational_nothing/>  <http://www.torontowater.org/asmp/dh/ontology/>}
GRAPH ?g8 {
?property_type rdfs:subClassOf famo:PropertyManifestation.}	

}

